---
import type { GetStaticPaths } from 'astro';
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

export const getStaticPaths = (async ({ paginate }) => {
	const posts = (await getCollection('blog')).sort(
		(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
	);
	return paginate(posts, { pageSize: 10 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const posts = page.data;
const pageNums = Array.from({ length: page.lastPage }, (_, i) => i + 1);

// Blade Runner: 负 delay 让雨滴在首次加载时就分布在全屏，不会全堆在顶部
const rainTypes = ['normal', 'thin', 'fog', 'skew'];
const rainDrops = Array.from({ length: 80 }, (_, i) => {
	const type = rainTypes[i % 4];
	return {
		left: `${Math.random() * 100}%`,
		delay: `${-5 + Math.random() * 6}s`, // -5~1s，动画“已开始”，初始即分散
		duration: `${2.5 + Math.random() * (type === 'thin' ? 0.8 : type === 'fog' || type === 'skew' ? 1.4 : 1.2)}s`,
		opacity: type === 'fog' ? 0.12 + Math.random() * 0.1 : 0.2 + Math.random() * 0.25,
	type,
	};
});
const dustParticles = Array.from({ length: 35 }, (_, i) => ({
	left: `${Math.random() * 100}%`,
	top: `${Math.random() * 100}%`,
	size: 4 + Math.random() * 4,
	delay: `${Math.random() * 10}s`,
	duration: `${8 + Math.random() * 12}s`,
}));
---
<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style is:global>
			/* Blade Runner - override global.css for blog page */
			body.page-blog {
				background: #0a0a12 !important;
				background-image: none !important;
				min-height: 100vh !important;
			}
		</style>
		<style>
			/* Blade Runner: fog + gradient */
			body.page-blog::before {
				content: '';
				position: fixed;
				inset: 0;
				z-index: -1;
				background: linear-gradient(
					180deg,
					#050508 0%,
					#0a0a12 20%,
					#0d1525 50%,
					#0a0a12 80%,
					#050508 100%
				);
			}
			body.page-blog::after {
				content: '';
				position: fixed;
				inset: 0;
				z-index: -1;
				background: radial-gradient(
						ellipse 80% 50% at 50% 20%,
						rgba(0, 150, 200, 0.15) 0%,
						transparent 50%
					),
					radial-gradient(
						ellipse 60% 40% at 80% 80%,
						rgba(255, 100, 150, 0.08) 0%,
						transparent 40%
					);
				animation: fog-drift 15s ease-in-out infinite alternate;
				pointer-events: none;
			}
			@keyframes fog-drift {
				0% {
					opacity: 0.7;
					transform: translate(-2%, -1%);
				}
				100% {
					opacity: 1;
					transform: translate(2%, 1%);
				}
			}

			/* Rain */
			.page-blog .br-rain {
				position: fixed;
				inset: 0;
				pointer-events: none;
				z-index: 6;
				overflow: hidden;
			}
			/* Blade Runner 风格：雨滴反射霓虹灯，上窄下宽水滴形 */
			.page-blog .br-rain-drop {
				position: absolute;
				top: -20px;
				width: 6px;
				height: 38px;
				clip-path: polygon(1.5px 0, 4.5px 0, 6px 100%, 0 100%);
				background: linear-gradient(
					to bottom,
					transparent 0%,
					rgba(255, 200, 150, 0.35) 40%,
					rgba(255, 180, 120, 0.5) 70%,
					transparent 100%
				);
				animation: rain-fall linear infinite;
			}
			@keyframes rain-fall {
				to {
					transform: translateY(100vh);
				}
			}

			/* Scanlines */
			.page-blog .br-scanlines {
				position: fixed;
				inset: 0;
				background: repeating-linear-gradient(
					0deg,
					transparent,
					transparent 2px,
					rgba(0, 0, 0, 0.55) 2px,
					rgba(0, 0, 0, 0.55) 4px
				);
				pointer-events: none;
				z-index: 4;
				opacity: 1;
			}

			/* 远光灯 / 探照灯：从角落发出，光柱延伸至对角线 × 1.3，置于内容背后、雨滴前 */
			.page-blog .br-spotlight {
				position: fixed;
				top: 0;
				left: 0;
				width: calc(hypot(100vw, 100vh) * 1.3 / 1.41421356);
				height: calc(hypot(100vw, 100vh) * 1.3 / 1.41421356);
				pointer-events: none;
				z-index: 5;
			}
			/* 左上角光柱：楔形指向右下角，光柱延伸至对角线长度 */
			.page-blog .br-spotlight-tl {
				position: absolute;
				inset: 0;
				transform-origin: 0 0;
				background: conic-gradient(
					from 180deg at 0 0,
					transparent 0deg 303deg,
					rgba(255, 220, 200, 0.06) 306deg,
					rgba(255, 210, 180, 0.2) 309deg,
					rgba(255, 200, 160, 0.35) 312deg,
					rgba(255, 210, 180, 0.2) 315deg,
					rgba(255, 220, 200, 0.06) 318deg,
					transparent 321deg 360deg
				);
				animation: spotlight-sweep-tl 10s ease-in-out infinite;
			}
			/* 右上角光柱：楔形指向左下角，光柱延伸至对角线长度，与左上角错峰扫描 */
			.page-blog .br-spotlight-tr {
				position: absolute;
				inset: 0;
				transform-origin: 100% 0;
				background: conic-gradient(
					from 180deg at 100% 0,
					transparent 0deg 33deg,
					rgba(255, 220, 200, 0.06) 36deg,
					rgba(255, 210, 180, 0.2) 39deg,
					rgba(255, 200, 160, 0.35) 42deg,
					rgba(255, 210, 180, 0.2) 45deg,
					rgba(255, 220, 200, 0.06) 48deg,
					transparent 51deg 360deg
				);
				animation: spotlight-sweep-tr 12s ease-in-out infinite;
				animation-delay: -2s;
			}
			@keyframes spotlight-sweep-tl {
				0% { transform: rotate(0deg); }
				50% { transform: rotate(-90deg); }
				100% { transform: rotate(0deg); }
			}
			@keyframes spotlight-sweep-tr {
				0%, 100% { transform: rotate(0deg); }
				50% { transform: rotate(90deg); }
			}

			/* 广告牌闪烁光 */
			.page-blog .br-flicker {
				position: fixed;
				inset: 0;
				background:
					radial-gradient(ellipse 25% 30% at 85% 20%, rgba(255, 100, 150, 0.45) 0%, transparent 55%),
					radial-gradient(ellipse 22% 25% at 15% 70%, rgba(0, 200, 255, 0.4) 0%, transparent 55%),
					radial-gradient(ellipse 28% 35% at 70% 85%, rgba(255, 180, 80, 0.4) 0%, transparent 55%);
				animation: neon-flicker-glow 4s ease-in-out infinite;
				pointer-events: none;
				z-index: 0;
			}
			@keyframes neon-flicker-glow {
				0%, 100% { opacity: 0.8; }
				25% { opacity: 1; }
				50% { opacity: 0.5; }
				75% { opacity: 0.95; }
			}

			/* 雾霾层叠加（z-index 1，在 post 图片/内容下方，作为背景氛围） */
			.page-blog .br-haze {
				position: fixed;
				inset: 0;
				background: radial-gradient(
					ellipse 100% 80% at 50% 50%,
					rgba(60, 80, 120, 0.08) 0%,
					transparent 60%
				);
				animation: haze-drift 20s ease-in-out infinite alternate;
				pointer-events: none;
				z-index: 1;
			}
			@keyframes haze-drift {
				0% { opacity: 0.5; transform: translate(3%, 2%) scale(1.05); }
				100% { opacity: 1; transform: translate(-3%, -2%) scale(0.95); }
			}

			/* CRT 暗角 */
			.page-blog .br-vignette {
				position: fixed;
				inset: 0;
				background: radial-gradient(
					ellipse 80% 80% at 50% 50%,
					transparent 40%,
					rgba(0, 0, 0, 0.4) 100%
				);
				pointer-events: none;
				z-index: 3;
			}

			/* 雨滴变体：thin 更细更快，fog 更淡 */
			.page-blog .br-rain-drop--thin {
				width: 4px;
				height: 28px;
				clip-path: polygon(0.5px 0, 3.5px 0, 4px 100%, 0 100%);
			}
			.page-blog .br-rain-drop--fog {
				opacity: 0.15;
				filter: blur(0.5px);
			}
			.page-blog .br-rain-drop--skew {
				animation-name: rain-fall-skew;
			}
			@keyframes rain-fall-skew {
				to { transform: skewX(-3deg) translateY(100vh); }
			}

			/* 悬浮尘埃 */
			.page-blog .br-dust {
				position: fixed;
				inset: 0;
				pointer-events: none;
				z-index: 2;
				overflow: hidden;
			}
			.page-blog .br-dust-particle {
				position: absolute;
				border-radius: 50%;
				background: rgba(255, 230, 190, 0.85);
				box-shadow: 0 0 12px rgba(255, 200, 150, 0.7), 0 0 24px rgba(255, 180, 120, 0.4);
				animation: dust-float linear infinite;
			}
			@keyframes dust-float {
				0% { transform: translate(0, 0) scale(1); opacity: 0.7; }
				25% { transform: translate(15px, -8px) scale(1.1); opacity: 0.95; }
				50% { transform: translate(-10px, -20px) scale(0.9); opacity: 0.8; }
				75% { transform: translate(8px, -15px) scale(1.05); opacity: 0.9; }
				100% { transform: translate(0, -30px) scale(1); opacity: 0.7; }
			}

			/* Main content */
			body.page-blog main {
				position: relative;
				z-index: 7;
				width: 960px;
				max-width: calc(100% - 2em);
			}
			body.page-blog .blog-list {
				display: flex;
				flex-wrap: wrap;
				gap: 1.5rem;
				list-style: none;
				margin: 0;
				padding: 0;
			}
			body.page-blog .blog-list li {
				width: calc(50% - 0.75rem);
				position: relative;
			}
			body.page-blog .blog-list li * {
				text-decoration: none;
				transition: 0.25s ease;
			}
			body.page-blog .blog-list li:first-child {
				width: 100%;
				margin-bottom: 0.5rem;
				text-align: center;
			}
			body.page-blog .blog-list .card {
				display: block;
				overflow: visible;
				border: 1px solid rgba(100, 180, 185, 0.3);
				border-radius: 4px;
				background: rgba(0, 0, 0, 0.4);
				padding: 0;
				box-shadow: 0 0 12px rgba(100, 180, 185, 0.04);
				transition: border-color 0.25s, box-shadow 0.25s;
			}
			body.page-blog .blog-list .card:hover {
				border-color: rgba(100, 180, 185, 0.5);
				box-shadow:
					0 0 8px rgba(100, 180, 185, 0.35),
					0 0 20px rgba(255, 150, 80, 0.15),
					0 0 40px rgba(255, 120, 0, 0.05);
				animation: neon-flicker 0.3s ease-in-out infinite;
			}
			@keyframes neon-flicker {
				0%,
				100% {
					box-shadow:
						0 0 8px rgba(100, 180, 185, 0.35),
						0 0 20px rgba(255, 150, 80, 0.15),
						0 0 40px rgba(255, 120, 0, 0.05);
				}
				50% {
					box-shadow:
						0 0 5px rgba(100, 180, 185, 0.25),
						0 0 14px rgba(255, 150, 80, 0.1),
						0 0 28px rgba(255, 120, 0, 0.03);
				}
			}
			body.page-blog .blog-list li:first-child .card {
				border-width: 2px;
				border-color: rgba(100, 180, 185, 0.45);
			}
			body.page-blog .blog-list .img-wrap {
				position: relative;
				overflow: hidden;
				margin: 0;
				display: block;
				border-radius: 4px;
			}
			/* 水平扫线 - Blade Runner 钠灯琥珀色 */
			body.page-blog .blog-list .img-wrap::before {
				content: '';
				position: absolute;
				left: 0;
				right: 0;
				top: -20px;
				height: 10px;
				z-index: 3;
				background: linear-gradient(
					90deg,
					transparent,
					rgba(255, 200, 120, 0.9),
					rgba(255, 190, 100, 0.95),
					rgba(255, 200, 120, 0.9),
					transparent
				);
				box-shadow: 0 0 20px rgba(255, 180, 80, 0.85), 0 0 40px rgba(255, 150, 60, 0.4);
				pointer-events: none;
				transition: top 1.2s linear;
			}
			body.page-blog .blog-list .card:hover .img-wrap::before {
				top: 100%;
			}
			/* Edge glow - ambient neon */
			body.page-blog .blog-list .img-wrap::after {
				content: '';
				position: absolute;
				inset: 0;
				z-index: 2;
				box-shadow: inset 0 0 25px rgba(100, 180, 185, 0.1), inset 0 0 50px rgba(255, 180, 80, 0.04);
				pointer-events: none;
				opacity: 0;
				transition: opacity 0.4s ease;
			}
			body.page-blog .blog-list .card:hover .img-wrap::after {
				opacity: 1;
			}
			body.page-blog .blog-list img {
				display: block;
				width: 100%;
				height: auto;
				margin: 0;
				border-radius: 4px;
				filter: saturate(0.75) contrast(1.05) brightness(0.88) sepia(0.15) hue-rotate(5deg);
				transition: filter 0.3s ease, box-shadow 0.3s ease;
			}
			body.page-blog .blog-list .card:hover img {
				filter: saturate(0.9) contrast(1.1) brightness(0.95) sepia(0.08) hue-rotate(2deg);
				box-shadow: 0 0 15px rgba(100, 180, 185, 0.2), 0 0 30px rgba(255, 150, 80, 0.12);
			}
			body.page-blog .blog-list .card-content {
				padding: 1rem 1.25rem;
				text-align: left;
			}
			body.page-blog .blog-list li:first-child .card-content {
				padding: 1.25rem 2rem;
			}
			body.page-blog .blog-list .title {
				margin: 0 0 0.35em 0;
				color: rgb(var(--text));
				line-height: 1.2;
				font-size: 1.25rem;
				text-shadow: 0 0 20px rgba(0, 212, 255, 0.15);
				transition: color 0.25s, text-shadow 0.25s;
			}
			body.page-blog .blog-list .card:hover .title {
				animation: glitch 0.3s ease-in-out;
			}
			@keyframes glitch {
				0% {
					transform: translate(0);
					text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
				}
				20% {
					transform: translate(-2px, 2px);
					text-shadow:
						2px 0 rgba(255, 0, 128, 0.8),
						-2px 0 rgba(0, 212, 255, 0.8);
				}
				40% {
					transform: translate(2px, -2px);
					text-shadow:
						-2px 0 rgba(0, 212, 255, 0.8),
						2px 0 rgba(255, 0, 128, 0.8);
				}
				60% {
					transform: translate(-1px, 1px);
				}
				80% {
					transform: translate(1px, -1px);
				}
				100% {
					transform: translate(0);
					text-shadow: 0 0 20px rgba(0, 212, 255, 0.5), 0 0 35px rgba(255, 120, 0, 0.2);
				}
			}
			body.page-blog .blog-list li:first-child .title {
				font-size: 2.369rem;
				color: rgb(130, 195, 200);
				text-shadow: 0 0 25px rgba(100, 180, 185, 0.35), 0 0 40px rgba(255, 180, 80, 0.12);
			}
			body.page-blog .blog-list .card:hover .title {
				color: rgb(140, 205, 210);
				text-shadow: 0 0 15px rgba(100, 180, 185, 0.45), 0 0 35px rgba(255, 180, 80, 0.2);
			}
			body.page-blog .blog-list .date {
				margin: 0;
				color: rgba(150, 180, 220, 0.7);
				font-size: 0.85rem;
				transition: color 0.25s;
			}
			body.page-blog .blog-list .card:hover .date {
				color: rgba(255, 150, 80, 0.9);
			}
			body.page-blog .pagination {
				display: flex;
				justify-content: center;
				align-items: center;
				gap: 0.5rem;
				margin-top: 2.5rem;
				padding: 1.5rem 0;
			}
			body.page-blog .pagination a {
				padding: 0.5rem 1rem;
				color: rgb(130, 200, 205);
				text-decoration: none;
				border: 1px solid rgba(100, 180, 185, 0.45);
				border-radius: 4px;
				transition: 0.25s ease;
				text-shadow: 0 0 10px rgba(100, 180, 185, 0.2);
			}
			body.page-blog .pagination a:hover {
				border-color: rgba(100, 180, 185, 0.8);
				text-shadow: 0 0 15px rgba(100, 180, 185, 0.4);
				box-shadow: 0 0 15px rgba(100, 180, 185, 0.15);
			}
			body.page-blog .pagination a.current {
				background: rgba(100, 180, 185, 0.1);
				border-color: rgb(130, 200, 205);
				color: rgb(140, 205, 210);
				text-shadow: 0 0 15px rgba(100, 180, 185, 0.4);
				box-shadow: 0 0 20px rgba(100, 180, 185, 0.2);
			}
			@media (max-width: 720px) {
				body.page-blog .blog-list {
					gap: 1rem;
				}
				body.page-blog .blog-list li {
					width: 100%;
					text-align: center;
				}
				body.page-blog .blog-list li:first-child .card-content {
					text-align: center;
				}
				body.page-blog .blog-list li:first-child .title {
					font-size: 1.563rem;
				}
			}
		</style>
	</head>
	<body class="page-blog">
		<!-- 远光灯 / 探照灯：左上、右上角旋转扫过 -->
		<div class="br-spotlight" aria-hidden="true">
			<div class="br-spotlight-tr"></div>
			<div class="br-spotlight-tl"></div>
		</div>
		<!-- 广告牌闪烁光 -->
		<div class="br-flicker" aria-hidden="true"></div>
		<!-- 雾霾层叠加 -->
		<div class="br-haze" aria-hidden="true"></div>
		<!-- CRT 暗角 -->
		<div class="br-vignette" aria-hidden="true"></div>
		<div class="br-rain" aria-hidden="true">
			{rainDrops.map((drop) => (
				<div
					class={`br-rain-drop br-rain-drop--${drop.type}`}
					style={{
						left: drop.left,
						animationDelay: drop.delay,
						animationDuration: drop.duration,
						opacity: drop.opacity,
					}}
				/>
			))}
		</div>
		<!-- 悬浮尘埃 -->
		<div class="br-dust" aria-hidden="true">
			{dustParticles.map((p) => (
				<div
					class="br-dust-particle"
					style={{
						left: p.left,
						top: p.top,
						width: p.size,
						height: p.size,
						animationDelay: p.delay,
						animationDuration: p.duration,
					}}
				/>
			))}
		</div>
		<div class="br-scanlines" aria-hidden="true"></div>

		<Header />
		<main>
			<section>
				<ul class="blog-list">
					{
						posts.map((post) => (
							<li>
								<a href={`/blog/${post.id}/`} class="card">
									{post.data.heroImage && (
										<span class="img-wrap">
											<Image width={720} height={360} src={post.data.heroImage} alt="" />
										</span>
									)}
									<div class="card-content">
										<h4 class="title">{post.data.title}</h4>
										<p class="date">
											<FormattedDate date={post.data.pubDate} />
										</p>
									</div>
								</a>
							</li>
						))
					}
				</ul>
			</section>
			{page.lastPage > 1 && (
				<nav class="pagination" aria-label="Pagination">
					{page.url.prev && <a href={page.url.prev}>Previous</a>}
					{pageNums.map((num) => (
						<a
							href={num === 1 ? '/blog/' : `/blog/${num}/`}
							class={num === page.currentPage ? 'current' : undefined}
							aria-current={num === page.currentPage ? 'page' : undefined}
						>
							{num}
						</a>
					))}
					{page.url.next && <a href={page.url.next}>Next</a>}
				</nav>
			)}
		</main>
		<Footer />
	</body>
</html>
